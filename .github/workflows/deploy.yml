name: 🚀 Deploy Melody Rent

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: 🔧 Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v4

      - name: 📡 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: 2222
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "🔁 Pulling latest code..."
            cd ~/apps/melody_rent
            git reset --hard HEAD
            git clean -fd
            git pull origin master

            echo "📦 Installing backend dependencies..."
            cd backend
            npm install

            echo "🚀 Restarting backend with PM2..."
            pm2 restart melody_backend || pm2 start index.js --name melody_backend

            echo "💻 Building frontend..."
            cd ../frontend
            npm install
            npm run build

            echo "🔄 Updating frontend files..."
            sudo rm -rf /home/reza1/apps/melody_rent/frontend-dist-temp
            mkdir -p /home/reza1/apps/melody_rent/frontend-dist-temp
            cp -r dist/* /home/reza1/apps/melody_rent/frontend-dist-temp/

            sudo rm -rf /home/reza1/apps/melody_rent/frontend/dist/*
            sudo cp -r /home/reza1/apps/melody_rent/frontend-dist-temp/* /home/reza1/apps/melody_rent/frontend/dist/
            sudo chown -R www-data:www-data /home/reza1/apps/melody_rent/frontend/dist

            echo "✅ Deploy complete."
          timeout: 300s
          command_timeout: 300s
